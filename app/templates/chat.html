<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Workout Companion - Chat with Fred</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 20px;
        }

        .chat-intro {
            padding: 0 24px 20px;
        }

        .chat-intro h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--white);
            line-height: 1.3;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: calc(100vh - 380px);
        }

        .message {
            display: flex;
            gap: 10px;
            max-width: 85%;
            animation: fadeInUp 0.3s ease;
        }

        .message.ai {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .message.ai .message-avatar {
            background: var(--secondary);
            color: var(--white);
        }

        .message.user .message-avatar {
            background: var(--secondary);
            color: var(--white);
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.ai .message-bubble {
            background: rgba(255, 255, 255, 0.15);
            color: var(--white);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: var(--white);
            color: var(--gray-800);
            border-bottom-right-radius: 4px;
        }

        .message-divider {
            width: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 4px auto;
            height: 16px;
        }

        .chat-action-card {
            background: rgba(30, 27, 75, 0.6);
            border-radius: 16px;
            padding: 16px;
            margin: 8px 0;
            align-self: flex-start;
            max-width: 85%;
        }

        .chat-action-card p {
            color: var(--white);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .chat-action-link {
            color: var(--secondary);
            font-size: 14px;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.2s;
        }

        .chat-action-link:hover {
            opacity: 0.8;
        }

        .app-container {
            padding-bottom: 160px;
            display: flex;
            flex-direction: column;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* Quick reply buttons */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0 16px;
            margin-bottom: 16px;
        }

        .quick-reply-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            color: var(--white);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-reply-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Override chat input for this page */
        .chat-input-container {
            background: transparent;
        }

        .chat-input {
            background: var(--white);
            border: none;
        }
    </style>
</head>
<body>
    <div class="device-frame">
        <div class="dynamic-island"></div>
        
        <div class="status-bar">
            <span class="time">9:41</span>
            <div class="icons">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3C6.95 3 3 5.95 3 9.5c0 2.4 1.56 4.5 3.89 5.72L4 21l4.39-2.17c1.14.39 2.37.67 3.61.67 5.05 0 9-2.95 9-6.5S17.05 3 12 3z"/>
                </svg>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
                </svg>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <rect x="2" y="7" width="20" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                    <rect x="4" y="9" width="14" height="8" rx="1" fill="currentColor"/>
                </svg>
            </div>
        </div>

        <div class="app-container">
            <div class="chat-header">
                <div></div>
                <button class="menu-button">
                    Menu
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </button>
                <div class="user-avatar" id="userAvatar">M</div>
            </div>

            <div class="chat-intro animate-fade-in">
                <h1>Hello! I'm Fred, your AI Fitness Companion.</h1>
            </div>

            <div class="messages-container" id="messages">
                <!-- Messages will be loaded here -->
            </div>

            <div class="quick-replies" id="quickReplies">
                <!-- Quick reply buttons will appear here -->
            </div>
        </div>

        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Enter Your Prompt Here..." onkeypress="handleKeypress(event)">
            <button class="send-btn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16V8M8 12l4-4 4 4"/>
                </svg>
            </button>
        </div>

        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                Home
            </a>
            <a href="workout-plan.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Plan
            </a>
            <a href="chat.html" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/>
                </svg>
                Chat
            </a>
            <a href="insights.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Insights
            </a>
            <a href="snapshot.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
                </svg>
                Today
            </a>
        </nav>
    </div>

    <script>
        // Chat state
        let chatState = {
            step: 0,
            userProfile: {
                name: '',
                age: '',
                weight: '',
                gender: '',
                height: '',
                goals: ''
            }
        };

        // Conversation flow
        const conversationFlow = [
            {
                question: "What is your full name or nickname you'd like to use?",
                field: 'name',
                quickReplies: []
            },
            {
                question: "What is your age?",
                field: 'age',
                quickReplies: ['18-25', '26-35', '36-45', '45+']
            },
            {
                question: "How much do you weigh (kg/lbs)?",
                field: 'weight',
                quickReplies: ['50 kg', '60 kg', '70 kg', '80 kg']
            },
            {
                question: "What is your gender?",
                field: 'gender',
                quickReplies: ['Male', 'Female', 'Other', 'Prefer not to say']
            },
            {
                question: "What is your height (cm/ft)?",
                field: 'height',
                quickReplies: ["5'0\"", "5'5\"", "5'10\"", "6'0\""]
            },
            {
                question: "What are your fitness goals?",
                field: 'goals',
                quickReplies: ['Lose weight', 'Build muscle', 'Get toned', 'Improve endurance']
            }
        ];

        // Load saved chat state
        function loadChatState() {
            const saved = localStorage.getItem('chatState');
            if (saved) {
                chatState = JSON.parse(saved);
            }
            
            const savedProfile = localStorage.getItem('userProfile');
            if (savedProfile) {
                chatState.userProfile = JSON.parse(savedProfile);
            }
        }

        // Save chat state
        function saveChatState() {
            localStorage.setItem('chatState', JSON.stringify(chatState));
            localStorage.setItem('userProfile', JSON.stringify(chatState.userProfile));
        }

        // Add message to chat
        function addMessage(content, type = 'ai', isAction = false) {
            const container = document.getElementById('messages');
            
            if (isAction) {
                const actionCard = document.createElement('div');
                actionCard.className = 'chat-action-card animate-fade-in';
                actionCard.innerHTML = content;
                container.appendChild(actionCard);
            } else {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type} animate-fade-in`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = type === 'ai' ? 'F' : (chatState.userProfile.name ? chatState.userProfile.name[0].toUpperCase() : 'M');
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = content;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(bubble);
                container.appendChild(messageDiv);
            }
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            const container = document.getElementById('messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">F</div>
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Hide typing indicator
        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        // Show quick replies
        function showQuickReplies(replies) {
            const container = document.getElementById('quickReplies');
            container.innerHTML = '';
            
            replies.forEach(reply => {
                const btn = document.createElement('button');
                btn.className = 'quick-reply-btn';
                btn.textContent = reply;
                btn.onclick = () => {
                    document.getElementById('chatInput').value = reply;
                    sendMessage();
                };
                container.appendChild(btn);
            });
        }

        // Clear quick replies
        function clearQuickReplies() {
            document.getElementById('quickReplies').innerHTML = '';
        }

        // Handle user message
        function handleKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            clearQuickReplies();
            
            // Process based on conversation state
            if (chatState.step < conversationFlow.length) {
                // Save response
                const field = conversationFlow[chatState.step].field;
                chatState.userProfile[field] = message;
                saveChatState();
                
                chatState.step++;
                
                // Show typing then next question
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    
                    if (chatState.step < conversationFlow.length) {
                        const next = conversationFlow[chatState.step];
                        addMessage(next.question);
                        if (next.quickReplies.length > 0) {
                            showQuickReplies(next.quickReplies);
                        }
                    } else {
                        // Onboarding complete - show fitness plan
                        generateFitnessPlan();
                    }
                    
                    saveChatState();
                }, 1000);
            } else {
                // Free chat - handle with dummy AI response
                handleFreeChat(message);
            }
        }

        // Generate fitness plan after onboarding
        function generateFitnessPlan() {
            const profile = chatState.userProfile;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                const planContent = `
                    <p>Here is your suggested fitness plan based on your goals:<br><br>
                    <strong>${profile.name}</strong>, to help you ${profile.goals.toLowerCase()}, I recommend:<br>
                    ‚Ä¢ Lift weights 4 times a week<br>
                    ‚Ä¢ Eat around 1800 calories a day<br>
                    ‚Ä¢ 15-minutes of cardio per workout session...</p>
                    <a href="dashboard.html" class="chat-action-link">
                        Go to the Fitness Dashboard to see your detailed fitness plan!
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </a>
                `;
                
                addMessage(planContent, 'ai', true);
                
                // Show follow-up options
                setTimeout(() => {
                    showQuickReplies([
                        'Change my workout days',
                        'Adjust my diet plan',
                        'Show me exercises',
                        'Track my progress'
                    ]);
                }, 500);
            }, 1500);
        }

        // Handle free chat after onboarding
        function handleFreeChat(message) {
            const lowerMessage = message.toLowerCase();
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                let response = '';
                let isAction = false;
                
                if (lowerMessage.includes('change') || lowerMessage.includes('modify') || lowerMessage.includes('adjust')) {
                    response = `
                        <p>Sure thing! I've updated your plan based on your request. Here's what I changed:<br><br>
                        ‚Ä¢ Adjusted your workout schedule<br>
                        ‚Ä¢ Modified exercise selection<br>
                        ‚Ä¢ Updated your calorie targets<br><br>
                        Check your fitness dashboard to see the updates!</p>
                        <a href="dashboard.html" class="chat-action-link">
                            View Updated Dashboard
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </a>
                    `;
                    isAction = true;
                } else if (lowerMessage.includes('exercise') || lowerMessage.includes('workout')) {
                    response = `
                        <p>Great! Here are some exercises I recommend for today:<br><br>
                        üèãÔ∏è <strong>Bicep Curls</strong> - 3 sets x 12 reps<br>
                        üí™ <strong>Tricep Extensions</strong> - 3 sets x 10 reps<br>
                        üî• <strong>Shoulder Press</strong> - 3 sets x 8 reps</p>
                        <a href="snapshot.html" class="chat-action-link">
                            Start Today's Workout
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </a>
                    `;
                    isAction = true;
                } else if (lowerMessage.includes('progress') || lowerMessage.includes('track') || lowerMessage.includes('stats')) {
                    response = `
                        <p>Looking at your progress this week:<br><br>
                        üìä <strong>Steps:</strong> 52,456 total<br>
                        üî• <strong>Calories:</strong> 2,100 burned<br>
                        üí™ <strong>Workouts:</strong> 3 completed<br>
                        üéØ <strong>Goal Progress:</strong> 50%</p>
                        <a href="insights.html" class="chat-action-link">
                            View Full Insights
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </a>
                    `;
                    isAction = true;
                } else if (lowerMessage.includes('diet') || lowerMessage.includes('food') || lowerMessage.includes('eat')) {
                    response = "For your goal of " + (chatState.userProfile.goals || "getting fit") + ", I recommend focusing on:\n\n‚Ä¢ High protein foods (chicken, fish, eggs)\n‚Ä¢ Complex carbs (brown rice, oats)\n‚Ä¢ Plenty of vegetables\n‚Ä¢ Stay hydrated with 8+ glasses of water\n\nWould you like me to create a detailed meal plan?";
                } else if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                    response = `Hey ${chatState.userProfile.name || 'there'}! üëã How can I help you with your fitness journey today? You can ask me about workouts, diet, progress tracking, or anything fitness related!`;
                } else {
                    const responses = [
                        "That's a great question! Based on your fitness profile, I'd recommend starting with light cardio and gradually increasing intensity.",
                        "I understand! Let me help you optimize your fitness routine. Would you like specific exercise recommendations?",
                        "Great point! Consistency is key in fitness. Let's work on building sustainable habits together.",
                        "I hear you! Remember, progress takes time. Let's adjust your plan to better fit your lifestyle."
                    ];
                    response = responses[Math.floor(Math.random() * responses.length)];
                }
                
                addMessage(response, 'ai', isAction);
                
                // Show contextual quick replies
                setTimeout(() => {
                    showQuickReplies([
                        'Show me today\'s workout',
                        'Track my progress',
                        'Update my plan',
                        'Diet tips'
                    ]);
                }, 500);
            }, 1200);
        }

        // Initialize chat
        function initChat() {
            loadChatState();
            
            // Update avatar
            if (chatState.userProfile.name) {
                document.getElementById('userAvatar').textContent = chatState.userProfile.name[0].toUpperCase();
            }
            
            // Load conversation history or start fresh
            if (chatState.step === 0) {
                // Start onboarding
                setTimeout(() => {
                    addMessage(conversationFlow[0].question);
                }, 500);
            } else if (chatState.step < conversationFlow.length) {
                // Resume onboarding
                rebuildChat();
            } else {
                // Show completed onboarding chat
                rebuildChat();
            }
        }

        // Rebuild chat from saved state
        function rebuildChat() {
            const container = document.getElementById('messages');
            
            for (let i = 0; i < chatState.step && i < conversationFlow.length; i++) {
                addMessage(conversationFlow[i].question);
                
                const field = conversationFlow[i].field;
                if (chatState.userProfile[field]) {
                    addMessage(chatState.userProfile[field], 'user');
                }
            }
            
            if (chatState.step >= conversationFlow.length) {
                generateFitnessPlan();
            } else if (chatState.step < conversationFlow.length) {
                const current = conversationFlow[chatState.step];
                addMessage(current.question);
                if (current.quickReplies.length > 0) {
                    showQuickReplies(current.quickReplies);
                }
            }
        }

        // Reset chat (for testing)
        function resetChat() {
            localStorage.removeItem('chatState');
            localStorage.removeItem('userProfile');
            location.reload();
        }

        // Start chat on load
        document.addEventListener('DOMContentLoaded', initChat);
    </script>
</body>
</html>
